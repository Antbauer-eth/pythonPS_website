<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STM32 Sound Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center justify-center">

    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <div class="bg-gray-900 p-6 text-center">
            <h1 class="text-2xl font-bold text-white tracking-wide">Sound Recognition</h1>
            <div class="flex items-center justify-center mt-2 space-x-2">
                <div id="conn-dot" class="w-3 h-3 rounded-full bg-red-500"></div>
                <p id="conn-text" class="text-xs text-gray-400 font-mono">Connecting...</p>
            </div>
        </div>

        <div class="p-10 text-center">
            <p class="text-sm font-semibold text-gray-500 uppercase tracking-widest mb-2">Current Detection</p>
            
            <div id="live-card" class="bg-gray-50 rounded-xl p-8 transition-colors duration-500">
                <h2 id="live-sound" class="text-5xl font-black text-gray-300 mb-4 transition-all duration-300">NOTHING DETECTED</h2>
                <div class="inline-flex items-center px-4 py-1 rounded-full bg-white shadow-sm border border-gray-200">
                    <span class="text-xs font-bold text-gray-400 mr-2">CONFIDENCE</span>
                    <span id="live-conf" class="text-xl font-bold text-gray-400">---</span>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 border-t border-gray-100 p-6 text-center">
            <p class="text-xs font-bold text-gray-400 mb-2">LAST CONFIRMED EVENT</p>
            <div class="flex flex-col items-center justify-center">
                <div id="history-box" class="bg-white px-6 py-3 rounded-lg shadow-sm border border-gray-200 transition-transform duration-200 transform scale-100">
                    <span id="history-sound" class="text-2xl font-bold text-gray-800">None</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
        const TOPIC = 'sound/report';
        const client = mqtt.connect(BROKER_URL);

        // Defined thresholds
        const THRESHOLDS = {
            "Whistle": 95,
            "Hey": 70,
            "Snap": 55,
            "Clap": 60,
            "Noise": 0 
        };

        const ui = {
            dot: document.getElementById('conn-dot'),
            text: document.getElementById('conn-text'),
            liveSound: document.getElementById('live-sound'),
            liveConf: document.getElementById('live-conf'),
            liveCard: document.getElementById('live-card'),
            histSound: document.getElementById('history-sound'),
            histBox: document.getElementById('history-box')
        };

        client.on('connect', () => {
            ui.dot.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]";
            ui.text.textContent = "ONLINE // SUBSCRIBED";
            client.subscribe(TOPIC);
        });

        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                
                if (data.status === "alive" && data.Noise !== undefined) {
                    
                    const scores = {
                        "Noise": data.Noise,
                        "Whistle": data.Whistle,
                        "Clap": data.Clap,
                        "Hey": data.Hey,
                        "Snap": data.Snap
                    };

                    // --- NEW LOGIC START ---

                    // 1. Find all classes that are strictly above (or equal to) their threshold
                    let candidates = Object.keys(scores).filter(key => scores[key] >= THRESHOLDS[key]);

                    // 2. Prioritize Logic: 
                    // If we have specific sounds (Whistle, Snap, etc.) AND Noise in the list, remove Noise.
                    const specificCandidates = candidates.filter(k => k !== "Noise");
                    
                    if (specificCandidates.length > 0) {
                        // We have actual events, so we ignore Noise
                        candidates = specificCandidates;
                    } 
                    // If specificCandidates is empty, 'candidates' remains just ["Noise"] (assuming Noise > 0) or empty.

                    let finalDecision = "Noise";
                    let finalScore = scores["Noise"];
                    let maxDiff = -Infinity;

                    // 3. Selection: Choose highest difference (Score - Threshold)
                    if (candidates.length > 0) {
                        candidates.forEach(key => {
                            let diff = scores[key] - THRESHOLDS[key];
                            if (diff > maxDiff) {
                                maxDiff = diff;
                                finalDecision = key;
                                finalScore = scores[key];
                            }
                        });
                    }

                    // --- NEW LOGIC END ---

                    // UI Updates
                    if (finalDecision === "Noise") {
                        ui.liveSound.textContent = "NOTHING DETECTED";
                        ui.liveConf.textContent = finalScore + "%";
                        ui.liveCard.className = "rounded-xl p-8 transition-colors duration-200 bg-gray-200";
                        ui.liveSound.className = "text-5xl font-black mb-4 transition-colors duration-200 text-gray-500";
                        ui.liveConf.className = "text-xl font-bold text-gray-500";
                    } else {
                        ui.liveSound.textContent = finalDecision.toUpperCase();
                        ui.liveConf.textContent = finalScore + "%";
                        ui.liveCard.className = "rounded-xl p-8 transition-colors duration-200 bg-green-100";
                        ui.liveSound.className = "text-6xl font-black mb-4 transition-colors duration-200 text-green-800";
                        ui.liveConf.className = "text-xl font-bold text-green-700";

                        ui.histSound.textContent = finalDecision.toUpperCase();

                        ui.histBox.classList.remove('scale-100');
                        ui.histBox.classList.add('scale-110', 'border-indigo-300');
                        setTimeout(() => {
                            ui.histBox.classList.remove('scale-110', 'border-indigo-300');
                            ui.histBox.classList.add('scale-100');
                        }, 200);
                    }
                }

            } catch (e) {
                console.error("JSON Error", e);
            }
        });
    </script>
</body>
</html>
